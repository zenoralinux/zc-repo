name: Build aarch64 AUR packages

on:
  workflow_dispatch:

jobs:
  build-packages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ARM64 packages in container
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/fwcd/archlinux:latest
          options: --platform linux/arm64 -v ${{ github.workspace }}/artifacts:/out
          shell: bash
          run: |
            pacman -Sy --noconfirm git base-devel sudo wget
            useradd -m builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            chown -R builder:builder /github/workspace

            # Install yay as builder
            sudo -u builder git clone https://aur.archlinux.org/yay.git /tmp/yay
            cd /tmp/yay
            sudo -u builder makepkg -si --noconfirm --skippgpcheck
            rm -rf /tmp/yay

            # Build packages
            mkdir -p /tmp/builds
            chown -R builder:builder /tmp/builds
            mkdir -p /out

            packages=(
              carburetor
              ascii-draw
              materialgram-bin
              gopeed-bin
            )

            for pkg in "${packages[@]}"; do
              echo "➡️ Building $pkg..."
              sudo -u builder yay -S --noconfirm --mflags="--skippgpcheck" --builddir=/tmp/builds "$pkg" \
                || echo "⚠️ Failed to build $pkg"
            done

            # Copy built packages to output directory
            find /tmp/builds -name '*.pkg.tar.zst' -exec cp {} /out/ \;

      - name: Upload built packages
        uses: actions/upload-artifact@v4
        with:
          name: built-aarch64-packages
          path: artifacts/
